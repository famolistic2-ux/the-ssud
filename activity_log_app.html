<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SUTimeTracker – Student Union timesheet tracking with mobile-first PWA, offline support, exports, and calendar sync.">
    <meta name="color-scheme" content="light dark">
    <meta name="theme-color" content="#1A1A2E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SUTimeTracker">
    <meta name="msapplication-TileColor" content="#1A1A2E">
    <meta name="msapplication-config" content="browserconfig.xml">
    <title>SUTimeTracker - City of Wolverhampton College</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <link rel="stylesheet" href="print.css" media="print">
    
    <!-- Error handling and user feedback -->
    <style>
        .error-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc2626;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .error-toast.show {
            transform: translateX(0);
        }
        .success-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #059669;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        .success-toast.show {
            transform: translateX(0);
        }
        .validation-error {
            border-color: #dc2626 !important;
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
        }
        .field-error {
            color: #dc2626;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .field-error.show {
            display: block;
        }
        
        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: inherit;
            margin: inherit;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }
        
        /* Focus indicators */
        .focus\:ring-2:focus {
            outline: 2px solid #D4AF37;
            outline-offset: 2px;
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .bg-cwc-gold {
                background-color: #000 !important;
                color: #fff !important;
            }
            .text-cwc-gold {
                color: #000 !important;
            }
        }
        
        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cwc-gold': '#D4AF37',
                        'cwc-yellow': '#F4D03F',
                        'cwc-navy': '#1A1A2E',
                        'cwc-dark': '#16213E',
                        'cwc-light': '#F8F9FA'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-success': 'pulseSuccess 0.6s ease-in-out',
                        'bounce-in': 'bounceIn 0.5s ease-out'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes pulseSuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50;
            pointer-events: auto;
        }
        @media (max-width: 768px) {
            .floating-btn {
                bottom: 80px;
            }
        }
        
        /* Desktop improvements */
        @media (min-width: 1024px) {
            .container {
                max-width: 1200px;
            }
            .touch-friendly {
                min-height: auto;
                padding: 8px 12px;
            }
        }
        .timer-pulse {
            animation: pulse 2s infinite;
        }
        .voice-recording {
            animation: pulse 1s infinite;
        }
        
        /* Enhanced Visual Improvements */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #D4AF37;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .button-press {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }
        
        .success-glow {
            animation: successGlow 0.6s ease-out;
        }
        
        @keyframes successGlow {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        
        .error-shake {
            animation: errorShake 0.5s ease-in-out;
        }
        
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            stroke-dasharray: 251.2;
            stroke-dashoffset: 251.2;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .dark .glass-card {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #D4AF37, #F4D03F);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .floating-animation {
            animation: floating 3s ease-in-out infinite;
        }
        
        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .pulse-glow {
            animation: pulseGlow 2s infinite;
        }
        
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(212, 175, 55, 0.5); }
            50% { box-shadow: 0 0 20px rgba(212, 175, 55, 0.8); }
        }
        
        /* Mobile Touch Improvements */
        @media (max-width: 768px) {
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            
            .mobile-swipe {
                touch-action: pan-x;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-card {
                margin-bottom: 1rem;
                padding: 1rem;
                border-radius: 0.75rem;
            }
            
            .mobile-button {
                padding: 0.75rem 1rem;
                font-size: 1rem;
                border-radius: 0.5rem;
                min-height: 48px;
            }
        }
        
        /* Enhanced Visual Effects */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }
        
        .ripple-effect::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple-effect:active::before {
            width: 300px;
            height: 300px;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .neon-glow {
            box-shadow: 0 0 5px currentColor, 0 0 10px currentColor, 0 0 15px currentColor;
        }
        
        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .dark .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* Dark mode styles */
        .dark {
            background: #0f172a;
            color: #f1f5f9;
        }
        .dark .bg-white { background-color: #1e293b; }
        .dark .bg-gray-50 { background-color: #334155; }
        .dark .bg-gray-100 { background-color: #475569; }
        .dark .text-gray-700 { color: #cbd5e1; }
        .dark .text-gray-600 { color: #94a3b8; }
        .dark .text-gray-800 { color: #f1f5f9; }
        .dark .border-gray-200 { border-color: #475569; }
        .dark .border { border-color: #475569; }

        /* Ensure all interactive elements are clickable */
        button, input, textarea, select, .nav-tab, .mobile-nav {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative !important;
            z-index: 10 !important;
        }
        input, textarea {
            cursor: text !important;
        }
    </style>
    <style>
        /* Print styles */
        @media print {
            header, nav, #fabBtn, .mobile-nav, #messageBox, #installBanner, #shortcutsModal, #voiceModal { display: none !important; }
            body { background: #fff; }
            .container, .max-w-7xl, .rounded-xl, .shadow-lg { box-shadow: none !important; }
            button { display: none !important; }
            #outputSection { display: block !important; border: none !important; }
            #reportOutput { font-size: 12px; color: #000; background: #fff !important; border: none !important; }
        }
    </style>
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" href="/icons/app-icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512.png">
    <link rel="preload" href="/icons/app-icon.svg" as="image" type="image/svg+xml">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#D4AF37">
    <meta name="apple-mobile-web-app-title" content="SUTimeTracker">
</head>
<body class="bg-gradient-to-br from-cwc-light to-gray-100 min-h-screen transition-all duration-300">
    <!-- Skip Navigation for Screen Readers -->
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-cwc-gold text-cwc-navy px-4 py-2 rounded-lg font-semibold z-50">
        Skip to main content
    </a>
    
    <!-- Header with College Branding -->
    <header class="bg-gradient-to-r from-cwc-navy to-cwc-dark text-white shadow-lg" role="banner">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-xl bg-cwc-gold flex items-center justify-center" role="img" aria-label="SUTimeTracker logo">
                        <img src="/icons/app-icon.svg" alt="SUTimeTracker logo" class="w-10 h-10" loading="eager" />
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold" id="main-title">SUTimeTracker</h1>
                        <p class="text-xs sm:text-sm text-cwc-yellow" aria-label="Institution name">City of Wolverhampton College</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="helpBtn" class="p-2 rounded-lg bg-cwc-dark hover:bg-opacity-80 transition-colors" 
                            title="Keyboard Shortcuts" aria-label="Show keyboard shortcuts help">
                        <span class="text-cwc-gold" aria-hidden="true">❓</span>
                    </button>
                    <button id="darkModeToggle" class="p-2 rounded-lg bg-cwc-dark hover:bg-opacity-80 transition-colors" 
                            title="Toggle Dark Mode" aria-label="Toggle between light and dark mode">
                        <span class="text-cwc-gold">🌙</span>
                    </button>
                    <button id="notificationToggle" class="p-2 rounded-lg bg-cwc-dark hover:bg-opacity-80 transition-colors" title="Toggle Notifications">
                        <span class="text-cwc-gold">🔔</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main id="main-content" class="container mx-auto px-3 sm:px-4 py-6 max-w-7xl" role="main" tabindex="-1">
        <!-- Navigation Tabs -->
        <nav class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow-md p-2 animate-fade-in" role="navigation" aria-label="Main navigation">
            <div class="flex flex-wrap gap-2">
                <button class="nav-tab active bg-cwc-gold text-cwc-navy px-4 py-2 rounded-md font-medium transition-all" 
                        data-view="dashboard" aria-label="View dashboard" aria-current="page">Dashboard</button>
                <button class="nav-tab bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md font-medium transition-all hover:bg-cwc-yellow" 
                        data-view="activities" aria-label="View activities">Activities</button>
                <button class="nav-tab bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md font-medium transition-all hover:bg-cwc-yellow" 
                        data-view="analytics" aria-label="View analytics">Analytics</button>
                <button class="nav-tab bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md font-medium transition-all hover:bg-cwc-yellow" 
                        data-view="calendar" aria-label="View calendar">Calendar</button>
                <button class="nav-tab bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-md font-medium transition-all hover:bg-cwc-yellow" data-view="timer">Timer</button>
            </div>
        </nav>

        <!-- Dashboard View -->
        <div id="dashboardView" class="view-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Install Card -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up card-hover">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="/icons/app-icon.svg" alt="SUTimeTracker" class="w-10 h-10" />
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Install SUTimeTracker</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Faster access, offline support</p>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button id="dashboardInstallBtn" aria-label="Install app" class="flex-1 bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-4 py-2 rounded-lg font-medium transition-colors">Install App</button>
                        <button id="iosInstallTipBtn" aria-label="How to install on iOS" class="flex-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Install on iOS</button>
                    </div>
                </div>
                <!-- Progress Card -->
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up card-hover">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white gradient-text">Monthly Progress</h2>
                        <div id="hoursStatus" class="px-4 py-2 rounded-full text-sm font-medium"></div>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-gray-600 dark:text-gray-300 font-medium">Total Hours</span>
                                <div class="flex items-center space-x-3">
                                    <div class="relative">
                                        <svg class="progress-ring w-16 h-16" width="64" height="64">
                                            <circle class="progress-ring-circle stroke-gray-200 dark:stroke-gray-700" stroke-width="4" fill="transparent" r="40" cx="32" cy="32"/>
                                            <circle id="progressCircle" class="progress-ring-circle stroke-cwc-gold" stroke-width="4" fill="transparent" r="40" cx="32" cy="32" style="stroke-dashoffset: 251.2"/>
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <span id="totalHours" class="text-lg font-bold text-cwc-gold">0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 relative overflow-hidden">
                                <div id="progressBar" class="bg-gradient-to-r from-cwc-gold to-cwc-yellow h-3 rounded-full transition-all duration-700 ease-out relative" style="width: 0%">
                                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
                                </div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-2">
                                <span class="flex items-center">
                                    <div class="w-2 h-2 bg-cwc-gold rounded-full mr-2"></div>
                                    0hrs completed
                                </span>
                                <span class="flex items-center">
                                    <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                                    30hrs required
                                </span>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                            <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/20 dark:to-blue-800/20 rounded-xl border border-blue-200 dark:border-blue-700 card-hover">
                                <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white text-xl">📞</span>
                                </div>
                                <div class="text-2xl font-bold text-blue-600" id="helpDeskHours">0</div>
                                <div class="text-xs text-blue-500 font-medium">Help Desk</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 rounded-xl border border-green-200 dark:border-green-700 card-hover">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white text-xl">🤝</span>
                                </div>
                                <div class="text-2xl font-bold text-green-600" id="meetingHours">0</div>
                                <div class="text-xs text-green-500 font-medium">Meetings</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 rounded-xl border border-purple-200 dark:border-purple-700 card-hover">
                                <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white text-xl">🎉</span>
                                </div>
                                <div class="text-2xl font-bold text-purple-600" id="eventHours">0</div>
                                <div class="text-xs text-purple-500 font-medium">Events</div>
                            </div>
                            <div class="text-center p-4 bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 rounded-xl border border-orange-200 dark:border-orange-700 card-hover">
                                <div class="w-12 h-12 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white text-xl">⚡</span>
                                </div>
                                <div class="text-2xl font-bold text-orange-600" id="otherHours">0</div>
                                <div class="text-xs text-orange-500 font-medium">Other</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up card-hover">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-6 gradient-text">Quick Actions</h3>
                    <div class="space-y-4">
                        <button class="quick-add-btn w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2" data-activity="SU Help Desk">
                            <span class="text-xl">📞</span>
                            <span>Log Help Desk</span>
                        </button>
                        <button class="quick-add-btn w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2" data-activity="Meeting">
                            <span class="text-xl">🤝</span>
                            <span>Log Meeting</span>
                        </button>
                        <button class="quick-add-btn w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-4 rounded-xl font-medium transition-all transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2" data-activity="Event">
                            <span class="text-xl">🎉</span>
                            <span>Log Event</span>
                        </button>
                        <button id="startTimerBtn" class="w-full bg-gradient-to-r from-cwc-gold to-cwc-yellow text-cwc-navy p-4 rounded-xl font-medium transition-all transform hover:scale-105 hover:shadow-lg flex items-center justify-center space-x-2 pulse-glow">
                            <span class="text-xl">⏱️</span>
                            <span>Start Timer</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 animate-slide-up">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Monthly Summary</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">What went well this month and what challenges did you overcome?</label>
                        <textarea id="monthlySummary" rows="4" 
                            class="w-full p-4 border border-gray-200 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-cwc-gold dark:bg-gray-700 dark:text-white transition-all" 
                            placeholder="Describe your overall experience this month, highlighting successes and challenges..."></textarea>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button id="voiceNoteBtn" class="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <span>🎤</span>
                            <span>Voice Note</span>
                        </button>
                        <button id="photoBtn" class="flex items-center space-x-2 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors">
                            <span>📷</span>
                            <span>Add Photo</span>
                        </button>
                        <input type="file" id="photoInput" accept="image/*" class="hidden">
                    </div>
                    <div id="photoGallery" class="grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- Activities View -->
        <div id="activitiesView" class="view-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white gradient-text">Activity Log</h2>
                    <div class="flex flex-wrap gap-2">
                        <button class="preset-btn bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-3 py-2 rounded-lg font-medium transition-all transform hover:scale-105" data-hours="1">1hr</button>
                        <button class="preset-btn bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-3 py-2 rounded-lg font-medium transition-all transform hover:scale-105" data-hours="2">2hrs</button>
                        <button class="preset-btn bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-3 py-2 rounded-lg font-medium transition-all transform hover:scale-105" data-hours="3">3hrs</button>
                        <button id="addRowButton" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-all transform hover:scale-105 mobile-button">
                            Add Activity
                        </button>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Search Activities</label>
                            <input type="text" id="activitySearch" placeholder="Search by activity name or notes..." 
                                   class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-600 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors"
                                   aria-label="Search activities by name or notes" aria-describedby="search-help">
                        </div>
                        <div class="sm:w-48">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter by Type</label>
                            <select id="activityFilter" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-600 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors">
                                <option value="">All Activities</option>
                                <option value="help desk">Help Desk</option>
                                <option value="meeting">Meetings</option>
                                <option value="event">Events</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="sm:w-48">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date Range</label>
                            <input type="date" id="dateFilter" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-600 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors"
                                   aria-label="Filter activities by date">
                        </div>
                        <div class="flex items-end">
                            <button id="clearFilters" class="px-4 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium transition-all transform hover:scale-105">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <div id="timeLogContainer" class="space-y-4">
                    <!-- Activity rows will be dynamically added here -->
                </div>

                <div class="mt-6 flex flex-wrap gap-2">
                    <button id="clearButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Clear All
                    </button>
                    <button id="generateButton" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Generate Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" class="view-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Activity Breakdown</h3>
                    <canvas id="activityChart" width="400" height="300"></canvas>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Weekly Progress</h3>
                    <canvas id="weeklyChart" width="400" height="300"></canvas>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-4">Monthly Trends</h3>
                    <canvas id="trendsChart" width="800" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="view-content hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Calendar View</h2>
                    <div class="flex items-center space-x-2">
                        <button id="prevMonth" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 transition-colors">←</button>
                        <span id="currentMonth" class="px-4 py-2 font-medium"></span>
                        <button id="nextMonth" class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 transition-colors">→</button>
                        <button id="exportICS" class="p-2 bg-cwc-gold text-cwc-navy rounded-lg hover:bg-cwc-yellow transition-colors" title="Export calendar (ICS)">Export</button>
                        <label class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 transition-colors cursor-pointer" title="Import ICS">
                            Import
                            <input id="importICS" type="file" accept="text/calendar,.ics" class="hidden" />
                        </label>
                    </div>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-1 text-center">
                    <!-- Calendar will be generated by JS -->
                </div>
            </div>
        </div>

        <!-- Timer View -->
        <div id="timerView" class="view-content hidden">
            <div class="max-w-md mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 text-center">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Activity Timer</h2>
                
                <div class="mb-6">
                    <input type="text" id="timerActivity" placeholder="Enter activity name..." class="w-full p-3 border rounded-lg text-center font-medium dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>

                <div id="timerDisplay" class="text-6xl font-mono font-bold text-cwc-gold mb-8">00:00:00</div>
                
                <div class="space-y-4">
                    <button id="timerStartStop" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg font-bold text-lg transition-all transform hover:scale-105">
                        START
                    </button>
                    <button id="timerPause" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white p-3 rounded-lg font-medium transition-all" disabled>
                        PAUSE
                    </button>
                    <button id="timerSave" class="w-full bg-gradient-to-r from-cwc-gold to-cwc-yellow text-cwc-navy p-3 rounded-lg font-medium transition-all" disabled>
                        SAVE ACTIVITY
                    </button>
                </div>
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="hidden fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 animate-bounce-in"></div>

        <!-- Output Section -->
        <div id="outputSection" class="hidden mt-8 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 animate-slide-up">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white">Monthly Report</h2>
                <div class="flex gap-2">
                    <button id="csvButton" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">Export CSV</button>
                    <button id="copyButton" class="bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-4 py-2 rounded-lg font-medium transition-colors">Copy to Clipboard</button>
                </div>
            </div>
            <pre id="reportOutput" class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg border text-sm overflow-x-auto whitespace-pre-wrap dark:text-gray-100"></pre>
        </div>
    </div>

    <!-- Install Prompt Banner (Mobile-friendly) -->
    <div id="installBanner" class="hidden fixed left-3 right-3 bottom-[calc(0.75rem+var(--sab,0))] z-50">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl p-4 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cwc-gold to-cwc-yellow text-cwc-navy flex items-center justify-center font-bold">W</div>
                <div>
                    <div class="text-sm font-semibold text-gray-800 dark:text-gray-100">Install Timesheet</div>
                    <div class="text-xs text-gray-500 dark:text-gray-400">Quick access, offline support</div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="dismissInstall" class="px-3 py-2 text-gray-600 dark:text-gray-300 text-sm">Not now</button>
                <button id="installBtn" class="px-3 py-2 bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy rounded-md text-sm font-semibold">Install</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="fabBtn" class="floating-btn bg-gradient-to-r from-cwc-gold to-cwc-yellow text-cwc-navy w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-xl font-bold hover:shadow-xl transition-all transform hover:scale-110">
        +
    </button>

    <!-- Bottom Navigation (Mobile) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 sm:hidden glass-morphism">
        <div class="grid grid-cols-5 py-2">
            <button class="mobile-nav touch-target flex flex-col items-center py-3 text-xs ripple-effect transition-all duration-200 active:scale-95" data-view="dashboard">
                <span class="text-lg mb-1 transition-transform duration-200">📊</span>
                <span class="font-medium">Dashboard</span>
            </button>
            <button class="mobile-nav touch-target flex flex-col items-center py-3 text-xs ripple-effect transition-all duration-200 active:scale-95" data-view="activities">
                <span class="text-lg mb-1 transition-transform duration-200">📝</span>
                <span class="font-medium">Activities</span>
            </button>
            <button class="mobile-nav touch-target flex flex-col items-center py-3 text-xs ripple-effect transition-all duration-200 active:scale-95" data-view="analytics">
                <span class="text-lg mb-1 transition-transform duration-200">📈</span>
                <span class="font-medium">Analytics</span>
            </button>
            <button class="mobile-nav touch-target flex flex-col items-center py-3 text-xs ripple-effect transition-all duration-200 active:scale-95" data-view="calendar">
                <span class="text-lg mb-1 transition-transform duration-200">📅</span>
                <span class="font-medium">Calendar</span>
            </button>
            <button class="mobile-nav touch-target flex flex-col items-center py-3 text-xs ripple-effect transition-all duration-200 active:scale-95" data-view="timer">
                <span class="text-lg mb-1 transition-transform duration-200">⏱️</span>
                <span class="font-medium">Timer</span>
            </button>
        </div>
    </nav>

    <!-- Voice Note Modal -->
    <div id="voiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4 dark:text-white">Voice Note</h3>
            <div class="text-center">
                <div id="voiceStatus" class="mb-4 text-gray-600 dark:text-gray-300">Press to start recording</div>
                <button id="voiceRecordBtn" class="bg-red-500 hover:bg-red-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl transition-colors">
                    🎤
                </button>
                <div class="mt-4 flex justify-end space-x-2">
                    <button id="voiceCancelBtn" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-lg">Cancel</button>
                    <button id="voiceSaveBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg" disabled>Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcutsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 max-w-2xl w-full max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold dark:text-white">Keyboard Shortcuts</h3>
                <button id="shortcutsCloseBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <span class="text-xl">×</span>
                </button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Navigation</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Switch to Dashboard</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+1</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Switch to Activities</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+2</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Switch to Analytics</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+3</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Switch to Calendar</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+4</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Switch to Timer</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+5</kbd>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Quick Actions</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Log Help Desk</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">H</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Log Meeting</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">M</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Log Event</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">E</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 dark:text-gray-300">Start Timer</span>
                                <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">T</kbd>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="border-t dark:border-gray-600 pt-4">
                    <h4 class="font-semibold text-gray-800 dark:text-white mb-2">General</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Save Activity</span>
                            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+S</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Generate Report</span>
                            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Ctrl+R</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Start/Stop Timer</span>
                            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Space</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-300">Close Modal</span>
                            <kbd class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded text-xs">Esc</kbd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- iOS Install Tip Modal -->
    <div id="iosTipModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 m-4 max-w-sm w-full">
            <h3 class="text-lg font-bold mb-3 dark:text-white">Install on iOS</h3>
            <ol class="list-decimal ml-5 space-y-2 text-sm text-gray-700 dark:text-gray-300">
                <li>Open in Safari</li>
                <li>Tap the Share icon</li>
                <li>Select “Add to Home Screen”</li>
            </ol>
            <div class="mt-4 flex justify-end">
                <button id="iosTipClose" class="px-4 py-2 bg-cwc-gold text-cwc-navy rounded">Got it</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let appState = {
            currentView: 'dashboard',
            isDarkMode: localStorage.getItem('darkMode') === 'true',
            timerInterval: null,
            timerStartTime: null,
            timerElapsed: 0,
            isTimerRunning: false,
            mediaRecorder: null,
            audioChunks: [],
            notificationsEnabled: localStorage.getItem('notifications') === 'true',
            localEntries: {},
            entryCounter: 1,
            charts: {
                activity: null,
                weekly: null,
                trends: null
            },
            loadingStates: {
                saving: false,
                generating: false,
                recording: false
            }
        };

        // Initialize app when DOM is ready
        function initializeApp() {
            console.log('Initializing app...');
            
            // Apply dark mode immediately
            if (appState.isDarkMode) {
                document.documentElement.classList.add('dark');
                const darkToggle = document.getElementById('darkModeToggle');
                if (darkToggle) {
                    darkToggle.innerHTML = '<span class="text-cwc-gold">☀️</span>';
                }
            }

            // Update notification toggle
            const notificationToggle = document.getElementById('notificationToggle');
            if (appState.notificationsEnabled && notificationToggle) {
                notificationToggle.classList.add('bg-cwc-gold');
            }

            // Initialize with dashboard view
            showView('dashboard');
            
            // Add initial activity row
            addInitialRow();
            
            // Load saved data
            loadMonthlySummary();
            
            // Update displays
            updateTotalHours();
            updateHoursStatus();
            updateQuickStats();
            
            console.log('App initialized successfully');
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', toggleDarkMode);
                console.log('Dark mode toggle attached');
            }
            
            // Notification toggle
            const notificationToggle = document.getElementById('notificationToggle');
            if (notificationToggle) {
                notificationToggle.addEventListener('click', toggleNotifications);
                console.log('Notification toggle attached');
            }

            // Navigation tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const view = tab.dataset.view;
                    console.log('Nav tab clicked:', view);
                    showView(view);
                });
            });
            console.log('Nav tabs attached:', navTabs.length);

            // Mobile navigation
            const mobileNavs = document.querySelectorAll('.mobile-nav');
            mobileNavs.forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const view = nav.dataset.view;
                    console.log('Mobile nav clicked:', view);
                    
                    // Add touch feedback
                    addButtonPressEffect(nav);
                    
                    // Update active state with animation
                    mobileNavs.forEach(n => {
                        n.classList.remove('text-cwc-gold', 'bg-cwc-gold/10');
                        n.querySelector('span:first-child').classList.remove('scale-110');
                    });
                    
                    nav.classList.add('text-cwc-gold', 'bg-cwc-gold/10');
                    nav.querySelector('span:first-child').classList.add('scale-110');
                    
                    showView(view);
                });
                
                // Add touch start/end events for better mobile feedback
                nav.addEventListener('touchstart', (e) => {
                    nav.classList.add('active:scale-95');
                });
                
                nav.addEventListener('touchend', (e) => {
                    setTimeout(() => {
                        nav.classList.remove('active:scale-95');
                    }, 150);
                });
            });
            console.log('Mobile nav attached:', mobileNavs.length);

            // Quick add buttons
            const quickAddButtons = document.querySelectorAll('.quick-add-btn');
            quickAddButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const activityName = button.dataset.activity;
                    console.log('Quick add clicked:', activityName);
                    addEntry({ activity: activityName });
                    showMessage(`Added ${activityName} entry`, 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                });
            });
            console.log('Quick add buttons attached:', quickAddButtons.length);

            // Preset hours buttons
            const presetButtons = document.querySelectorAll('.preset-btn');
            presetButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const hours = parseInt(button.dataset.hours);
                    console.log('Preset button clicked:', hours);
                    const now = new Date();
                    const endTime = now.toTimeString().slice(0, 5);
                    const startTime = new Date(now.getTime() - (hours * 60 * 60 * 1000)).toTimeString().slice(0, 5);
                    
                    addEntry({ 
                        startTime: startTime, 
                        endTime: endTime,
                        activity: 'SU Help Desk'
                    });
                    showMessage(`Added ${hours}hr activity`, 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300');
                });
            });
            console.log
            console.log('Preset buttons attached:', presetButtons.length);

            // Add row button
            const addRowButton = document.getElementById('addRowButton');
            if (addRowButton) {
                addRowButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Add row button clicked');
                    addActivityRow();
                });
            }

            // Clear and generate buttons
            const clearButton = document.getElementById('clearButton');
            if (clearButton) {
                clearButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Clear button clicked');
                    clearAllEntries();
                });
            }

            const generateButton = document.getElementById('generateButton');
            if (generateButton) {
                generateButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Generate button clicked');
                    generateReport();
                });
            }

            // Timer functionality
            const timerStartStop = document.getElementById('timerStartStop');
            const timerPause = document.getElementById('timerPause');
            const timerSave = document.getElementById('timerSave');
            const timerActivity = document.getElementById('timerActivity');

            if (timerStartStop) {
                timerStartStop.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Timer start/stop clicked');
                    toggleTimer();
                });
            }

            if (timerPause) {
                timerPause.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Timer pause clicked');
                    pauseTimer();
                });
            }

            if (timerSave) {
                timerSave.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Timer save clicked');
                    saveTimerActivity();
                });
            }

            // Start timer button from dashboard
            const startTimerBtn = document.getElementById('startTimerBtn');
            if (startTimerBtn) {
                startTimerBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Start timer from dashboard clicked');
                    showView('timer');
                });
            }

            // Voice note functionality
            const voiceNoteBtn = document.getElementById('voiceNoteBtn');
            const voiceModal = document.getElementById('voiceModal');
            const voiceRecordBtn = document.getElementById('voiceRecordBtn');
            const voiceCancelBtn = document.getElementById('voiceCancelBtn');
            const voiceSaveBtn = document.getElementById('voiceSaveBtn');

            if (voiceNoteBtn) {
                voiceNoteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Voice note button clicked');
                    showVoiceModal();
                });
            }

            if (voiceRecordBtn) {
                voiceRecordBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Voice record button clicked');
                    toggleVoiceRecording();
                });
            }

            if (voiceCancelBtn) {
                voiceCancelBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Voice cancel button clicked');
                    hideVoiceModal();
                });
            }

            if (voiceSaveBtn) {
                voiceSaveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Voice save button clicked');
                    saveVoiceNote();
                });
            }

            // Photo functionality
            const photoBtn = document.getElementById('photoBtn');
            const photoInput = document.getElementById('photoInput');

            if (photoBtn) {
                photoBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Photo button clicked');
                    photoInput.click();
                });
            }

            if (photoInput) {
                photoInput.addEventListener('change', (e) => {
                    console.log('Photo selected');
                    handlePhotoUpload(e);
                });
            }

            // Monthly summary
            const monthlySummary = document.getElementById('monthlySummary');
            if (monthlySummary) {
                monthlySummary.addEventListener('input', (e) => {
                    saveMonthlySummary();
                });
            }

            // FAB button
            const fabBtn = document.getElementById('fabBtn');
            if (fabBtn) {
                fabBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('FAB clicked');
                    showView('activities');
                });
            }

            // Calendar navigation
            const prevMonth = document.getElementById('prevMonth');
            const nextMonth = document.getElementById('nextMonth');
            const exportICSBtn = document.getElementById('exportICS');
            const importICSInput = document.getElementById('importICS');

            if (prevMonth) {
                prevMonth.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Previous month clicked');
                    changeMonth(-1);
                });
            }

            if (nextMonth) {
                nextMonth.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Next month clicked');
                    changeMonth(1);
                });
            }

            if (exportICSBtn) {
                exportICSBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Export ICS clicked');
                    exportActivitiesAsICS();
                });
            }

            if (importICSInput) {
                importICSInput.addEventListener('change', async (e) => {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    try {
                        await importActivitiesFromICS(file);
                        showMessage('ICS imported successfully', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                    } catch (err) {
                        console.error(err);
                        showMessage('Failed to import ICS', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                    } finally {
                        e.target.value = '';
                    }
                });
            }

            // Copy button
            const copyButton = document.getElementById('copyButton');
            if (copyButton) {
                copyButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Copy button clicked');
                    copyReport();
                });
            }
            const csvButton = document.getElementById('csvButton');
            if (csvButton) {
                csvButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    exportCSV();
                });
            }

            // Dashboard install card
            const dashboardInstallBtn = document.getElementById('dashboardInstallBtn');
            const iosInstallTipBtn = document.getElementById('iosInstallTipBtn');
            if (dashboardInstallBtn) {
                dashboardInstallBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // Reuse install banner logic
                    const bannerInstall = document.getElementById('installBtn');
                    if (bannerInstall) bannerInstall.click();
                });
            }
            if (iosInstallTipBtn) {
                iosInstallTipBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const m = document.getElementById('iosTipModal');
                    if (m) m.classList.remove('hidden');
                });
            }
            const iosTipClose = document.getElementById('iosTipClose');
            if (iosTipClose) {
                iosTipClose.addEventListener('click', (e) => {
                    e.preventDefault();
                    const m = document.getElementById('iosTipModal');
                    if (m) m.classList.add('hidden');
                });
            }

            // Help button
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Help button clicked');
                    showShortcutsModal();
                });
            }

            // Shortcuts modal
            const shortcutsCloseBtn = document.getElementById('shortcutsCloseBtn');
            if (shortcutsCloseBtn) {
                shortcutsCloseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Shortcuts close clicked');
                    hideShortcutsModal();
                });
            }

            // Search and filter functionality
            const activitySearch = document.getElementById('activitySearch');
            const activityFilter = document.getElementById('activityFilter');
            const dateFilter = document.getElementById('dateFilter');
            const clearFilters = document.getElementById('clearFilters');

            if (activitySearch) {
                activitySearch.addEventListener('input', () => {
                    console.log('Search input changed');
                    filterActivities();
                });
            }

            if (activityFilter) {
                activityFilter.addEventListener('change', () => {
                    console.log('Filter changed');
                    filterActivities();
                });
            }

            if (dateFilter) {
                dateFilter.addEventListener('change', () => {
                    console.log('Date filter changed');
                    filterActivities();
                });
            }

            if (clearFilters) {
                clearFilters.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Clear filters clicked');
                    clearAllFilters();
                });
            }

            console.log('All event listeners attached successfully');
            
            // Add keyboard shortcuts
            setupKeyboardShortcuts();
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Only trigger shortcuts when not typing in inputs
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                // Ctrl/Cmd + number keys for navigation
                if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '5') {
                    e.preventDefault();
                    const views = ['dashboard', 'activities', 'analytics', 'calendar', 'timer'];
                    const viewIndex = parseInt(e.key) - 1;
                    if (views[viewIndex]) {
                        showView(views[viewIndex]);
                        showMessage(`Switched to ${views[viewIndex]}`, 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300');
                    }
                }
                
                // Ctrl/Cmd + S to save current activity
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (appState.currentView === 'activities') {
                        // Save the first unsaved activity row
                        const saveBtn = document.querySelector('.save-row-btn');
                        if (saveBtn) {
                            saveBtn.click();
                            showMessage('Activity saved', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                        }
                    }
                }
                
                // Ctrl/Cmd + R to generate report
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    generateReport();
                }
                
                // Space to start/stop timer (when on timer view)
                if (e.key === ' ' && appState.currentView === 'timer') {
                    e.preventDefault();
                    const timerBtn = document.getElementById('timerStartStop');
                    if (timerBtn) {
                        timerBtn.click();
                    }
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    const voiceModal = document.getElementById('voiceModal');
                    const shortcutsModal = document.getElementById('shortcutsModal');
                    if (voiceModal && !voiceModal.classList.contains('hidden')) {
                        hideVoiceModal();
                    } else if (shortcutsModal && !shortcutsModal.classList.contains('hidden')) {
                        hideShortcutsModal();
                    }
                }
                
                // F1 or ? to show shortcuts
                if (e.key === 'F1' || e.key === '?') {
                    e.preventDefault();
                    showShortcutsModal();
                }
                
                // Quick add shortcuts
                if (e.key === 'h' && appState.currentView === 'dashboard') {
                    e.preventDefault();
                    const helpDeskBtn = document.querySelector('[data-activity="SU Help Desk"]');
                    if (helpDeskBtn) helpDeskBtn.click();
                }
                if (e.key === 'm' && appState.currentView === 'dashboard') {
                    e.preventDefault();
                    const meetingBtn = document.querySelector('[data-activity="Meeting"]');
                    if (meetingBtn) meetingBtn.click();
                }
                if (e.key === 'e' && appState.currentView === 'dashboard') {
                    e.preventDefault();
                    const eventBtn = document.querySelector('[data-activity="Event"]');
                    if (eventBtn) eventBtn.click();
                }
                if (e.key === 't' && appState.currentView === 'dashboard') {
                    e.preventDefault();
                    const timerBtn = document.getElementById('startTimerBtn');
                    if (timerBtn) timerBtn.click();
                }
            });
        }

        // View management
        function showView(viewName) {
            console.log('Switching to view:', viewName);
            
            // Hide all views
            const views = document.querySelectorAll('.view-content');
            views.forEach(view => view.classList.add('hidden'));
            
            // Show selected view
            const selectedView = document.getElementById(viewName + 'View');
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }
            
            // Update navigation tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => {
                if (tab.dataset.view === viewName) {
                    tab.classList.add('active', 'bg-cwc-gold', 'text-cwc-navy');
                    tab.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                } else {
                    tab.classList.remove('active', 'bg-cwc-gold', 'text-cwc-navy');
                    tab.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                }
            });
            
            // Update mobile navigation
            const mobileNavs = document.querySelectorAll('.mobile-nav');
            mobileNavs.forEach(nav => {
                if (nav.dataset.view === viewName) {
                    nav.classList.add('text-cwc-gold');
                } else {
                    nav.classList.remove('text-cwc-gold');
                }
            });
            
            appState.currentView = viewName;
            
            // Initialize view-specific functionality
            if (viewName === 'analytics') {
                initializeCharts();
            } else if (viewName === 'calendar') {
                generateCalendar();
            }
        }

        // Dark mode toggle
        function toggleDarkMode() {
            console.log('Toggling dark mode');
            appState.isDarkMode = !appState.isDarkMode;
            document.documentElement.classList.toggle('dark', appState.isDarkMode);
            localStorage.setItem('darkMode', appState.isDarkMode);
            
            const darkToggle = document.getElementById('darkModeToggle');
            if (darkToggle) {
                darkToggle.innerHTML = appState.isDarkMode ? 
                    '<span class="text-cwc-gold">☀️</span>' : 
                    '<span class="text-cwc-gold">🌙</span>';
            }
        }

        // Notification toggle
        function toggleNotifications() {
            console.log('Toggling notifications');
            appState.notificationsEnabled = !appState.notificationsEnabled;
            localStorage.setItem('notifications', appState.notificationsEnabled);
            
            const notificationToggle = document.getElementById('notificationToggle');
            if (notificationToggle) {
                if (appState.notificationsEnabled) {
                    notificationToggle.classList.add('bg-cwc-gold');
                } else {
                    notificationToggle.classList.remove('bg-cwc-gold');
                }
            }
        }

        // Activity management
        function addEntry(data) {
            console.log('Adding entry:', data);
            const entry = {
                id: appState.entryCounter++,
                date: data.date || new Date().toISOString().split('T')[0],
                startTime: data.startTime || '09:00',
                endTime: data.endTime || '17:00',
                activity: data.activity || 'General Activity',
                notes: data.notes || '',
                hours: calculateHours(data.startTime || '09:00', data.endTime || '17:00')
            };
            
            appState.localEntries[entry.id] = entry;
            updateTotalHours();
            updateHoursStatus();
            updateQuickStats();
            showMessage(`Added ${entry.activity} entry`, 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
        }

        function addActivityRow() {
            console.log('Adding activity row');
            trackEvent('activity_row_added');
            const container = document.getElementById('timeLogContainer');
            if (!container) return;
            
            const rowId = 'row_' + Date.now();
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 card-hover';
            row.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-center">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date <span class="text-red-500">*</span></label>
                        <input type="date" class="date-input w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors" value="${new Date().toISOString().split('T')[0]}" required>
                        <div class="date-error text-xs text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time <span class="text-red-500">*</span></label>
                        <input type="time" class="start-time-input w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors" value="09:00" required>
                        <div class="start-time-error text-xs text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Time <span class="text-red-500">*</span></label>
                        <input type="time" class="end-time-input w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors" value="17:00" required>
                        <div class="end-time-error text-xs text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Activity <span class="text-red-500">*</span></label>
                        <input type="text" class="activity-input w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors" placeholder="Activity name" required>
                        <div class="activity-error text-xs text-red-500 mt-1 hidden"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                        <input type="text" class="notes-input w-full p-2 border rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white focus:ring-2 focus:ring-cwc-gold focus:border-cwc-gold transition-colors" placeholder="Notes">
                    </div>
                    <div class="flex flex-col gap-2">
                        <button class="save-row-btn bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span class="save-text">Save</span>
                            <span class="loading-text hidden">Saving...</span>
                        </button>
                        <button class="add-calendar-btn bg-cwc-gold hover:bg-cwc-yellow text-cwc-navy px-3 py-2 rounded-lg text-sm transition-all transform hover:scale-105">Add to Calendar</button>
                        <button class="delete-row-btn bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm transition-all transform hover:scale-105">Delete</button>
                    </div>
                </div>
            `;
            
            container.appendChild(row);
            
            // Add event listeners to the new row
            const saveBtn = row.querySelector('.save-row-btn');
            const deleteBtn = row.querySelector('.delete-row-btn');
            const addCalBtn = row.querySelector('.add-calendar-btn');
            const inputs = row.querySelectorAll('input[required]');
            
            // Real-time validation
            inputs.forEach(input => {
                input.addEventListener('input', () => validateActivityRow(row));
                input.addEventListener('blur', () => validateActivityRow(row));
            });
            
            if (saveBtn) {
                saveBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Save row clicked');
                    if (validateActivityRow(row)) {
                        saveActivityRow(row);
                    }
                });
            }
            
            if (deleteBtn) {
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Delete row clicked');
                    deleteActivityRow(row);
                });
            }

            if (addCalBtn) {
                addCalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Add to calendar clicked');
                    exportSingleRowICS(row);
                });
            }
        }

        function validateActivityRow(row) {
            const dateInput = row.querySelector('.date-input');
            const startTimeInput = row.querySelector('.start-time-input');
            const endTimeInput = row.querySelector('.end-time-input');
            const activityInput = row.querySelector('.activity-input');
            
            let isValid = true;
            
            // Clear previous errors
            row.querySelectorAll('.error').forEach(error => error.classList.add('hidden'));
            row.querySelectorAll('input').forEach(input => {
                input.classList.remove('border-red-500', 'ring-red-500');
                input.classList.add('border-gray-300', 'dark:border-gray-600');
            });
            
            // Validate date
            if (!dateInput.value) {
                showFieldError(row, 'date', 'Date is required');
                isValid = false;
            }
            
            // Validate activity name
            if (!activityInput.value.trim()) {
                showFieldError(row, 'activity', 'Activity name is required');
                isValid = false;
            }
            
            // Validate times
            if (!startTimeInput.value || !endTimeInput.value) {
                if (!startTimeInput.value) showFieldError(row, 'start-time', 'Start time is required');
                if (!endTimeInput.value) showFieldError(row, 'end-time', 'End time is required');
                isValid = false;
            } else if (startTimeInput.value >= endTimeInput.value) {
                showFieldError(row, 'end-time', 'End time must be after start time');
                isValid = false;
            }
            
            // Update save button state
            const saveBtn = row.querySelector('.save-row-btn');
            if (saveBtn) {
                saveBtn.disabled = !isValid;
            }
            
            return isValid;
        }

        function showFieldError(row, fieldName, message) {
            const input = row.querySelector(`.${fieldName}-input`);
            const errorDiv = row.querySelector(`.${fieldName}-error`);
            
            if (input) {
                input.classList.remove('border-gray-300', 'dark:border-gray-600');
                input.classList.add('border-red-500', 'ring-red-500');
            }
            
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
        }

        function addInitialRow() {
            addActivityRow();
        }

        function saveActivityRow(row) {
            console.log('Saving activity row');
            const dateInput = row.querySelector('.date-input');
            const startTimeInput = row.querySelector('.start-time-input');
            const endTimeInput = row.querySelector('.end-time-input');
            const activityInput = row.querySelector('.activity-input');
            const notesInput = row.querySelector('.notes-input');
            const saveBtn = row.querySelector('.save-row-btn');
            
            if (!dateInput || !startTimeInput || !endTimeInput || !activityInput) return;
            
            // Show loading state
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading-spinner"></div>Saving...';
            }
            
            // Simulate processing time
            setTimeout(() => {
                try {
                    const entry = {
                        id: appState.entryCounter++,
                        date: dateInput.value,
                        startTime: startTimeInput.value,
                        endTime: endTimeInput.value,
                        activity: activityInput.value,
                        notes: notesInput.value || '',
                        hours: calculateHours(startTimeInput.value, endTimeInput.value)
                    };
                    
                    appState.localEntries[entry.id] = entry;
                    updateTotalHours();
                    updateHoursStatus();
                    updateQuickStats();
                    
                    // Add success effect to the row
                    addSuccessEffect(row);
                    
                    // Update save button to show success
                    if (saveBtn) {
                        saveBtn.innerHTML = '✅ Saved';
                        saveBtn.classList.add('bg-green-600');
                        saveBtn.classList.remove('bg-green-500');
                        
                        // Reset after 2 seconds
                        setTimeout(() => {
                            saveBtn.innerHTML = 'Save';
                            saveBtn.classList.remove('bg-green-600');
                            saveBtn.classList.add('bg-green-500');
                            saveBtn.disabled = false;
                        }, 2000);
                    }
                    
                    showMessage('Activity saved successfully', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                } catch (error) {
                    console.error('Error saving activity:', error);
                    addErrorEffect(row);
                    showMessage('Error saving activity', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                    
                    // Reset save button
                    if (saveBtn) {
                        saveBtn.innerHTML = 'Save';
                        saveBtn.disabled = false;
                    }
                }
            }, 500);
        }

        function deleteActivityRow(row) {
            console.log('Deleting activity row');
            row.remove();
        }

        function clearAllEntries() {
            console.log('Clearing all entries');
            if (confirm('Are you sure you want to clear all entries?')) {
                appState.localEntries = {};
                appState.entryCounter = 1;
                updateTotalHours();
                updateHoursStatus();
                updateQuickStats();
                
                const container = document.getElementById('timeLogContainer');
                if (container) {
                    container.innerHTML = '';
                }
                
                showMessage('All entries cleared', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
            }
        }

        // Timer functionality
        function toggleTimer() {
            console.log('Toggling timer');
            if (appState.isTimerRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            console.log('Starting timer');
            appState.timerStartTime = Date.now() - appState.timerElapsed;
            appState.isTimerRunning = true;
            
            appState.timerInterval = setInterval(updateTimerDisplay, 1000);
            
            const timerStartStop = document.getElementById('timerStartStop');
            const timerPause = document.getElementById('timerPause');
            const timerSave = document.getElementById('timerSave');
            
            if (timerStartStop) {
                timerStartStop.textContent = 'STOP';
                timerStartStop.className = 'w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white p-4 rounded-lg font-bold text-lg transition-all transform hover:scale-105';
            }
            
            if (timerPause) {
                timerPause.disabled = false;
            }
            
            if (timerSave) {
                timerSave.disabled = false;
            }
        }

        function stopTimer() {
            console.log('Stopping timer');
            appState.isTimerRunning = false;
            
            if (appState.timerInterval) {
                clearInterval(appState.timerInterval);
                appState.timerInterval = null;
            }
            
            const timerStartStop = document.getElementById('timerStartStop');
            const timerPause = document.getElementById('timerPause');
            
            if (timerStartStop) {
                timerStartStop.textContent = 'START';
                timerStartStop.className = 'w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg font-bold text-lg transition-all transform hover:scale-105';
            }
            
            if (timerPause) {
                timerPause.disabled = true;
                timerPause.textContent = 'PAUSE';
            }
        }

        function pauseTimer() {
            console.log('Pausing timer');
            if (appState.isTimerRunning) {
                appState.isTimerRunning = false;
                if (appState.timerInterval) {
                    clearInterval(appState.timerInterval);
                }
                
                const timerPause = document.getElementById('timerPause');
                if (timerPause) {
                    timerPause.textContent = 'RESUME';
                }
            } else {
                appState.isTimerRunning = true;
                appState.timerStartTime = Date.now() - appState.timerElapsed;
                appState.timerInterval = setInterval(updateTimerDisplay, 1000);
                
                const timerPause = document.getElementById('timerPause');
                if (timerPause) {
                    timerPause.textContent = 'PAUSE';
                }
            }
        }

        function updateTimerDisplay() {
            if (!appState.isTimerRunning) return;
            
            appState.timerElapsed = Date.now() - appState.timerStartTime;
            const hours = Math.floor(appState.timerElapsed / 3600000);
            const minutes = Math.floor((appState.timerElapsed % 3600000) / 60000);
            const seconds = Math.floor((appState.timerElapsed % 60000) / 1000);
            
            const display = document.getElementById('timerDisplay');
            if (display) {
                display.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        function saveTimerActivity() {
            console.log('Saving timer activity');
            const activityName = document.getElementById('timerActivity');
            if (!activityName || !activityName.value.trim()) {
                showMessage('Please enter an activity name', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                return;
            }
            
            const hours = appState.timerElapsed / 3600000;
            const now = new Date();
            const endTime = now.toTimeString().slice(0, 5);
            const startTime = new Date(now.getTime() - appState.timerElapsed).toTimeString().slice(0, 5);
            
            addEntry({
                date: now.toISOString().split('T')[0],
                startTime: startTime,
                endTime: endTime,
                activity: activityName.value,
                notes: `Timer activity (${hours.toFixed(2)} hours)`
            });
            
            // Reset timer
            appState.timerElapsed = 0;
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = '00:00:00';
            }
            
            const timerStartStop = document.getElementById('timerStartStop');
            const timerPause = document.getElementById('timerPause');
            const timerSave = document.getElementById('timerSave');
            
            if (timerStartStop) {
                timerStartStop.textContent = 'START';
                timerStartStop.className = 'w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg font-bold text-lg transition-all transform hover:scale-105';
            }
            
            if (timerPause) {
                timerPause.disabled = true;
                timerPause.textContent = 'PAUSE';
            }
            
            if (timerSave) {
                timerSave.disabled = true;
            }
            
            if (activityName) {
                activityName.value = '';
            }
            
            showMessage('Timer activity saved', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
        }

        // Voice note functionality
        function showVoiceModal() {
            console.log('Showing voice modal');
            const modal = document.getElementById('voiceModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function hideVoiceModal() {
            console.log('Hiding voice modal');
            const modal = document.getElementById('voiceModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function toggleVoiceRecording() {
            console.log('Toggling voice recording');
            if (appState.mediaRecorder && appState.mediaRecorder.state === 'recording') {
                stopVoiceRecording();
            } else {
                startVoiceRecording();
            }
        }

        function startVoiceRecording() {
            console.log('Starting voice recording');
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    appState.mediaRecorder = new MediaRecorder(stream);
                    appState.audioChunks = [];
                    
                    appState.mediaRecorder.ondataavailable = event => {
                        appState.audioChunks.push(event.data);
                    };
                    
                    appState.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(appState.audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        console.log('Voice recording completed');
                        showMessage('Voice note recorded successfully', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                    };
                    
                    appState.mediaRecorder.start();
                    
                    const voiceStatus = document.getElementById('voiceStatus');
                    const voiceRecordBtn = document.getElementById('voiceRecordBtn');
                    const voiceSaveBtn = document.getElementById('voiceSaveBtn');
                    
                    if (voiceStatus) {
                        voiceStatus.textContent = 'Recording... Click to stop';
                    }
                    
                    if (voiceRecordBtn) {
                        voiceRecordBtn.classList.add('voice-recording');
                    }
                    
                    if (voiceSaveBtn) {
                        voiceSaveBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error accessing microphone:', error);
                    showMessage('Could not access microphone', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                });
        }

        function stopVoiceRecording() {
            console.log('Stopping voice recording');
            if (appState.mediaRecorder && appState.mediaRecorder.state === 'recording') {
                appState.mediaRecorder.stop();
                
                const voiceStatus = document.getElementById('voiceStatus');
                const voiceRecordBtn = document.getElementById('voiceRecordBtn');
                
                if (voiceStatus) {
                    voiceStatus.textContent = 'Recording stopped. Click to record again.';
                }
                
                if (voiceRecordBtn) {
                    voiceRecordBtn.classList.remove('voice-recording');
                }
            }
        }

        function saveVoiceNote() {
            console.log('Saving voice note');
            hideVoiceModal();
            showMessage('Voice note saved to monthly summary', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
        }

        // Photo functionality
        function handlePhotoUpload(event) {
            console.log('Handling photo upload');
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoGallery = document.getElementById('photoGallery');
                if (photoGallery) {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'relative';
                    photoDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-20 object-cover rounded-lg">
                        <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs" onclick="removePhoto(this)">×</button>
                    `;
                    photoGallery.appendChild(photoDiv);
                }
            };
            reader.readAsDataURL(file);
        }

        function removePhoto(button) {
            console.log('Removing photo');
            button.parentElement.remove();
        }

        // Monthly summary
        function saveMonthlySummary() {
            const summary = document.getElementById('monthlySummary');
            if (summary) {
                localStorage.setItem('monthlySummary', summary.value);
            }
        }

        function loadMonthlySummary() {
            const summary = document.getElementById('monthlySummary');
            const saved = localStorage.getItem('monthlySummary');
            if (summary && saved) {
                summary.value = saved;
            }
        }

        // Calendar functionality
        function generateCalendar() {
            console.log('Generating calendar');
            const calendar = document.getElementById('calendar');
            if (!calendar) return;
            
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            
            const currentMonth = document.getElementById('currentMonth');
            if (currentMonth) {
                currentMonth.textContent = `${monthNames[month]} ${year}`;
            }
            
            calendar.innerHTML = '';
            
            // Add day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'font-bold text-gray-600 dark:text-gray-300 p-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'p-2';
                calendar.appendChild(emptyCell);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'p-2 border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                dayCell.textContent = day;
                calendar.appendChild(dayCell);
            }
        }

        function changeMonth(direction) {
            console.log('Changing month:', direction);
            // This would update the calendar month
            generateCalendar();
        }

        // Chart functionality
        function initializeCharts() {
            console.log('Initializing charts');
            
            // Activity breakdown chart
            const activityCtx = document.getElementById('activityChart');
            if (activityCtx && !appState.charts.activity) {
                appState.charts.activity = new Chart(activityCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Help Desk', 'Meetings', 'Events', 'Other'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#3B82F6', '#10B981', '#8B5CF6', '#F59E0B']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Weekly progress chart
            const weeklyCtx = document.getElementById('weeklyChart');
            if (weeklyCtx && !appState.charts.weekly) {
                appState.charts.weekly = new Chart(weeklyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'Hours',
                            data: [0, 0, 0, 0],
                            backgroundColor: '#D4AF37'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Trends chart
            const trendsCtx = document.getElementById('trendsChart');
            if (trendsCtx && !appState.charts.trends) {
                appState.charts.trends = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Monthly Hours',
                            data: [0, 0, 0, 0, 0, 0],
                            borderColor: '#D4AF37',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        // Utility functions
        function calculateHours(startTime, endTime) {
            const start = new Date(`2000-01-01T${startTime}:00`);
            const end = new Date(`2000-01-01T${endTime}:00`);
            const diffMs = end - start;
            return Math.max(0, diffMs / (1000 * 60 * 60));
        }

        function updateTotalHours() {
            let total = 0;
            Object.values(appState.localEntries).forEach(entry => {
                total += entry.hours || 0;
            });
            
            const totalHoursElement = document.getElementById('totalHours');
            if (totalHoursElement) {
                totalHoursElement.textContent = total.toFixed(2);
            }
            
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                const percentage = Math.min((total / 30) * 100, 100);
                progressBar.style.width = percentage + '%';
            }
            
            // Update circular progress indicator
            const progressCircle = document.getElementById('progressCircle');
            if (progressCircle) {
                const percentage = Math.min((total / 30) * 100, 100);
                const circumference = 2 * Math.PI * 40; // radius = 40
                const offset = circumference - (percentage / 100) * circumference;
                progressCircle.style.strokeDashoffset = offset;
                
                // Add success effect when reaching 100%
                if (percentage >= 100) {
                    addSuccessEffect(progressCircle);
                }
            }
        }

        function updateHoursStatus() {
            let total = 0;
            Object.values(appState.localEntries).forEach(entry => {
                total += entry.hours || 0;
            });
            
            const statusElement = document.getElementById('hoursStatus');
            if (statusElement) {
                if (total >= 30) {
                    statusElement.textContent = '✅ Complete';
                    statusElement.className = 'px-4 py-2 rounded-full text-sm font-medium bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300';
                } else {
                    statusElement.textContent = `${(30 - total).toFixed(1)}hrs remaining`;
                    statusElement.className = 'px-4 py-2 rounded-full text-sm font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300';
                }
            }
        }

        function updateQuickStats() {
            let helpDesk = 0, meetings = 0, events = 0, other = 0;
            
            Object.values(appState.localEntries).forEach(entry => {
                const activity = entry.activity.toLowerCase();
                if (activity.includes('help desk')) {
                    helpDesk += entry.hours || 0;
                } else if (activity.includes('meeting')) {
                    meetings += entry.hours || 0;
                } else if (activity.includes('event')) {
                    events += entry.hours || 0;
                } else {
                    other += entry.hours || 0;
                }
            });
            
            const helpDeskElement = document.getElementById('helpDeskHours');
            const meetingElement = document.getElementById('meetingHours');
            const eventElement = document.getElementById('eventHours');
            const otherElement = document.getElementById('otherHours');
            
            if (helpDeskElement) helpDeskElement.textContent = helpDesk.toFixed(1);
            if (meetingElement) meetingElement.textContent = meetings.toFixed(1);
            if (eventElement) eventElement.textContent = events.toFixed(1);
            if (otherElement) otherElement.textContent = other.toFixed(1);
        }

        function generateReport() {
            console.log('Generating report');
            
            // Show loading state
            setLoadingState('generateButton', true, 'Generating...');
            showLoadingOverlay(true);
            
            // Simulate processing time for better UX
            setTimeout(() => {
                try {
                    let report = 'SU PRESIDENT MONTHLY TIMESHEET REPORT\n';
                    report += 'City of Wolverhampton College\n';
                    report += 'Generated: ' + new Date().toLocaleDateString() + '\n\n';
                    
                    report += 'ACTIVITY LOG:\n';
                    report += 'Date\t\tStart\tEnd\t\tActivity\t\t\tHours\tNotes\n';
                    report += '-'.repeat(80) + '\n';
                    
                    Object.values(appState.localEntries).forEach(entry => {
                        report += `${entry.date}\t${entry.startTime}\t${entry.endTime}\t${entry.activity.padEnd(20)}\t${entry.hours.toFixed(2)}\t${entry.notes}\n`;
                    });
                    
                    let totalHours = 0;
                    Object.values(appState.localEntries).forEach(entry => {
                        totalHours += entry.hours || 0;
                    });
                    
                    report += '\n' + '-'.repeat(80) + '\n';
                    report += `TOTAL HOURS: ${totalHours.toFixed(2)}\n`;
                    report += `REQUIRED HOURS: 30.00\n`;
                    report += `STATUS: ${totalHours >= 30 ? 'COMPLETE' : 'INCOMPLETE'}\n\n`;
                    
                    const summary = document.getElementById('monthlySummary');
                    if (summary && summary.value.trim()) {
                        report += 'MONTHLY SUMMARY:\n';
                        report += summary.value + '\n';
                    }
                    
                    const outputSection = document.getElementById('outputSection');
                    const reportOutput = document.getElementById('reportOutput');
                    
                    if (outputSection && reportOutput) {
                        reportOutput.textContent = report;
                        outputSection.classList.remove('hidden');
                        
                        // Add success effect
                        addSuccessEffect(outputSection);
                        showMessage('Report generated successfully', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                    }
                } catch (error) {
                    console.error('Error generating report:', error);
                    showMessage('Error generating report', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                } finally {
                    // Hide loading state
                    setLoadingState('generateButton', false, 'Generate Report');
                    showLoadingOverlay(false);
                }
            }, 1000);
        }

        function copyReport() {
            console.log('Copying report');
            const reportOutput = document.getElementById('reportOutput');
            if (reportOutput) {
                navigator.clipboard.writeText(reportOutput.textContent).then(() => {
                    showMessage('Report copied to clipboard', 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300');
                }).catch(() => {
                    showMessage('Failed to copy report', 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300');
                });
            }
        }

        function exportCSV() {
            const headers = ['Date','Start','End','Activity','Hours','Notes'];
            const rows = Object.values(appState.localEntries).map(e => [e.date, e.startTime, e.endTime, (e.activity||'').replace(/,/g,' '), (e.hours||0).toFixed(2), (e.notes||'').replace(/,/g,' ')]);
            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'timesheet.csv'; a.click(); URL.revokeObjectURL(url);
        }

        // ICS Export/Import
        function pad2(n) { return String(n).padStart(2, '0'); }
        function toICSDate(dateStr, timeStr) {
            // dateStr: YYYY-MM-DD, timeStr: HH:MM
            const [y,m,d] = dateStr.split('-').map(Number);
            const [hh,mm] = timeStr.split(':').map(Number);
            return `${y}${pad2(m)}${pad2(d)}T${pad2(hh)}${pad2(mm)}00`;
        }

        function exportActivitiesAsICS() {
            const lines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//CWC//Timesheet//EN'
            ];
            Object.values(appState.localEntries).forEach((entry) => {
                const uid = `ts-${entry.id}@cwc`;
                const dtStart = toICSDate(entry.date, entry.startTime || '09:00');
                const dtEnd = toICSDate(entry.date, entry.endTime || '17:00');
                const summary = (entry.activity || 'Activity').replace(/\n/g, ' ');
                const description = (entry.notes || '').replace(/\n/g, ' ');
                lines.push('BEGIN:VEVENT');
                lines.push(`UID:${uid}`);
                lines.push(`DTSTAMP:${dtStart}Z`);
                lines.push(`DTSTART:${dtStart}Z`);
                lines.push(`DTEND:${dtEnd}Z`);
                lines.push(`SUMMARY:${summary}`);
                if (description) lines.push(`DESCRIPTION:${description}`);
                lines.push('END:VEVENT');
            });
            lines.push('END:VCALENDAR');
            const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'timesheet.ics';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importActivitiesFromICS(file) {
            const text = await file.text();
            // Minimal ICS parse: split VEVENTs
            const events = text.split('BEGIN:VEVENT').slice(1).map(v => 'BEGIN:VEVENT' + v);
            events.forEach((evt) => {
                const get = (key) => {
                    const m = evt.match(new RegExp(`^${key}:(.+)$`, 'm'));
                    return m ? m[1].trim() : '';
                };
                const dtStart = get('DTSTART');
                const dtEnd = get('DTEND');
                const summary = get('SUMMARY') || 'Imported Activity';
                const description = get('DESCRIPTION') || '';
                // Parse YYYYMMDDTHHMMSS or YYYYMMDDTHHMM
                const parseDT = (s) => {
                    const y = s.slice(0,4), m = s.slice(4,6), d = s.slice(6,8), hh = s.slice(9,11), mm = s.slice(11,13);
                    return { date: `${y}-${m}-${d}`, time: `${hh}:${mm}` };
                };
                if (!dtStart || !dtEnd) return;
                const s = parseDT(dtStart);
                const e = parseDT(dtEnd);
                addEntry({ date: s.date, startTime: s.time, endTime: e.time, activity: summary, notes: description });
            });
            updateTotalHours();
            updateHoursStatus();
            updateQuickStats();
        }

        function exportSingleRowICS(row) {
            const dateInput = row.querySelector('.date-input');
            const startTimeInput = row.querySelector('.start-time-input');
            const endTimeInput = row.querySelector('.end-time-input');
            const activityInput = row.querySelector('.activity-input');
            const notesInput = row.querySelector('.notes-input');
            if (!dateInput || !startTimeInput || !endTimeInput || !activityInput) return;
            const lines = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//CWC//Timesheet//EN',
                'BEGIN:VEVENT',
                `UID:row-${Date.now()}@cwc`,
                `DTSTAMP:${toICSDate(dateInput.value, startTimeInput.value)}Z`,
                `DTSTART:${toICSDate(dateInput.value, startTimeInput.value)}Z`,
                `DTEND:${toICSDate(dateInput.value, endTimeInput.value)}Z`,
                `SUMMARY:${(activityInput.value || 'Activity').replace(/\n/g, ' ')}`,
                notesInput && notesInput.value ? `DESCRIPTION:${notesInput.value.replace(/\n/g, ' ')}` : '',
                'END:VEVENT',
                'END:VCALENDAR'
            ].filter(Boolean);
            const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(activityInput.value || 'activity').replace(/\s+/g,'_')}.ics`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showMessage(message, className) {
            console.log('Showing message:', message);
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.className = `fixed top-20 right-4 p-4 rounded-lg shadow-lg z-50 animate-bounce-in ${className}`;
                messageBox.classList.remove('hidden');
                
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }
        }

        // Loading state management
        function setLoadingState(elementId, isLoading, loadingText = 'Loading...') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (isLoading) {
                element.disabled = true;
                element.innerHTML = `<div class="loading-spinner"></div>${loadingText}`;
                element.classList.add('opacity-75');
            } else {
                element.disabled = false;
                element.classList.remove('opacity-75');
            }
        }

        function showLoadingOverlay(show = true) {
            let overlay = document.getElementById('loadingOverlay');
            if (!overlay && show) {
                overlay = document.createElement('div');
                overlay.id = 'loadingOverlay';
                overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                overlay.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg p-6 flex items-center space-x-3">
                        <div class="loading-spinner"></div>
                        <span class="text-gray-700 dark:text-gray-300">Processing...</span>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else if (overlay && !show) {
                overlay.remove();
            }
        }

        function addButtonPressEffect(button) {
            button.classList.add('button-press');
            setTimeout(() => {
                button.classList.remove('button-press');
            }, 100);
        }

        function addSuccessEffect(element) {
            element.classList.add('success-glow');
            setTimeout(() => {
                element.classList.remove('success-glow');
            }, 600);
        }

        function addErrorEffect(element) {
            element.classList.add('error-shake');
            setTimeout(() => {
                element.classList.remove('error-shake');
            }, 500);
        }

        // Shortcuts modal functions
        function showShortcutsModal() {
            console.log('Showing shortcuts modal');
            const modal = document.getElementById('shortcutsModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        function hideShortcutsModal() {
            console.log('Hiding shortcuts modal');
            const modal = document.getElementById('shortcutsModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        // Search and filter functions
        function filterActivities() {
            const searchTerm = document.getElementById('activitySearch')?.value.toLowerCase() || '';
            const filterType = document.getElementById('activityFilter')?.value || '';
            const filterDate = document.getElementById('dateFilter')?.value || '';
            
            const rows = document.querySelectorAll('#timeLogContainer > div');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const activityInput = row.querySelector('.activity-input');
                const notesInput = row.querySelector('.notes-input');
                const dateInput = row.querySelector('.date-input');
                
                if (!activityInput) return;
                
                const activity = activityInput.value.toLowerCase();
                const notes = notesInput?.value.toLowerCase() || '';
                const date = dateInput?.value || '';
                
                let showRow = true;
                
                // Search filter
                if (searchTerm && !activity.includes(searchTerm) && !notes.includes(searchTerm)) {
                    showRow = false;
                }
                
                // Type filter
                if (filterType) {
                    if (filterType === 'help desk' && !activity.includes('help desk')) {
                        showRow = false;
                    } else if (filterType === 'meeting' && !activity.includes('meeting')) {
                        showRow = false;
                    } else if (filterType === 'event' && !activity.includes('event')) {
                        showRow = false;
                    } else if (filterType === 'other' && (activity.includes('help desk') || activity.includes('meeting') || activity.includes('event'))) {
                        showRow = false;
                    }
                }
                
                // Date filter
                if (filterDate && date !== filterDate) {
                    showRow = false;
                }
                
                if (showRow) {
                    row.style.display = 'block';
                    row.classList.add('animate-fade-in');
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show no results message
            const container = document.getElementById('timeLogContainer');
            let noResultsMsg = document.getElementById('noResultsMessage');
            
            if (visibleCount === 0 && (searchTerm || filterType || filterDate)) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.id = 'noResultsMessage';
                    noResultsMsg.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                    noResultsMsg.innerHTML = `
                        <div class="text-6xl mb-4">🔍</div>
                        <h3 class="text-lg font-medium mb-2">No activities found</h3>
                        <p class="text-sm">Try adjusting your search or filter criteria</p>
                    `;
                    container.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }

        function clearAllFilters() {
            const activitySearch = document.getElementById('activitySearch');
            const activityFilter = document.getElementById('activityFilter');
            const dateFilter = document.getElementById('dateFilter');
            
            if (activitySearch) activitySearch.value = '';
            if (activityFilter) activityFilter.value = '';
            if (dateFilter) dateFilter.value = '';
            
            // Show all rows
            const rows = document.querySelectorAll('#timeLogContainer > div');
            rows.forEach(row => {
                row.style.display = 'block';
            });
            
            // Hide no results message
            const noResultsMsg = document.getElementById('noResultsMessage');
            if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
            
            showMessage('Filters cleared', 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300');
        }

        // Enhanced error handling and data validation
        function showError(message, duration = 5000) {
            console.error('Error:', message);
            showToast(message, 'error', duration);
        }

        function showSuccess(message, duration = 3000) {
            console.log('Success:', message);
            showToast(message, 'success', duration);
        }

        function showToast(message, type = 'error', duration = 5000) {
            // Remove existing toasts
            document.querySelectorAll('.error-toast, .success-toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = type === 'error' ? 'error-toast' : 'success-toast';
            toast.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        ${type === 'error' ? 
                            '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' :
                            '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>'
                        }
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="flex-shrink-0 ml-4">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Enhanced data validation and sanitization
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            return input.trim().replace(/[<>]/g, '');
        }

        function validateTimeFormat(time) {
            const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            return timeRegex.test(time);
        }

        function validateDate(dateString) {
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date) && date <= new Date();
        }

        function validateActivityData(activity) {
            const errors = [];
            
            // Required fields
            if (!activity.date || !validateDate(activity.date)) {
                errors.push('Valid date is required');
            }
            
            if (!activity.activity || activity.activity.trim().length < 3) {
                errors.push('Activity name must be at least 3 characters');
            }
            
            if (!activity.startTime || !validateTimeFormat(activity.startTime)) {
                errors.push('Valid start time is required (HH:MM format)');
            }
            
            if (!activity.endTime || !validateTimeFormat(activity.endTime)) {
                errors.push('Valid end time is required (HH:MM format)');
            }
            
            // Time logic validation
            if (activity.startTime && activity.endTime) {
                const start = new Date(`2000-01-01 ${activity.startTime}`);
                const end = new Date(`2000-01-01 ${activity.endTime}`);
                
                if (start >= end) {
                    errors.push('End time must be after start time');
                }
                
                // Check for reasonable duration (not more than 12 hours)
                const duration = (end - start) / (1000 * 60 * 60);
                if (duration > 12) {
                    errors.push('Activity duration cannot exceed 12 hours');
                }
            }
            
            // Sanitize inputs
            activity.activity = sanitizeInput(activity.activity);
            activity.notes = sanitizeInput(activity.notes || '');
            
            return {
                isValid: errors.length === 0,
                errors: errors,
                sanitizedData: activity
            };
        }

        // Performance monitoring
        function logPerformance() {
            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                if (perfData) {
                    console.log('Performance metrics:', {
                        domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                        loadComplete: perfData.loadEventEnd - perfData.loadEventStart,
                        totalTime: perfData.loadEventEnd - perfData.fetchStart
                    });
                }
            }
        }

        // Basic analytics (privacy-friendly)
        function trackEvent(eventName, properties = {}) {
            console.log('Analytics:', eventName, properties);
            // Store locally for basic usage tracking
            const analytics = JSON.parse(localStorage.getItem('sutimetracker_analytics') || '{}');
            analytics[eventName] = (analytics[eventName] || 0) + 1;
            analytics.lastActivity = new Date().toISOString();
            localStorage.setItem('sutimetracker_analytics', JSON.stringify(analytics));
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            trackEvent('error', { message: event.error?.message });
            showError('An unexpected error occurred. Please try again.');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            trackEvent('promise_rejection', { reason: event.reason?.message });
            showError('An unexpected error occurred. Please try again.');
        });

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            trackEvent('app_loaded');
            logPerformance();
            initializeApp();
            setupEventListeners();
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js').then(() => {
                    console.log('Service worker registered');
                }).catch((e) => console.warn('SW registration failed', e));
            }
            // Install prompt handling
            let deferredPrompt = null;
            const banner = document.getElementById('installBanner');
            const installBtn = document.getElementById('installBtn');
            const dismissBtn = document.getElementById('dismissInstall');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (banner) banner.classList.remove('hidden');
            });
            if (installBtn) {
                installBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('Install outcome:', outcome);
                    deferredPrompt = null;
                    if (banner) banner.classList.add('hidden');
                });
            }
            if (dismissBtn) {
                dismissBtn.addEventListener('click', () => {
                    if (banner) banner.classList.add('hidden');
                });
            }
            // iOS safe area support for mobile footer/header
            document.documentElement.style.setProperty('--sat', 'env(safe-area-inset-top)');
            document.documentElement.style.setProperty('--sar', 'env(safe-area-inset-right)');
            document.documentElement.style.setProperty('--sab', 'env(safe-area-inset-bottom)');
            document.documentElement.style.setProperty('--sal', 'env(safe-area-inset-left)');
            console.log('✅ App loaded successfully!');
        });

        // Global functions for inline event handlers
        window.removePhoto = removePhoto;
    </script>
</body>
</html>
